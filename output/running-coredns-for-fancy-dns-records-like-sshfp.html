<!DOCTYPE html>
<html lang="en">
<head>
		<link rel="stylesheet" type="text/css" href="/theme/css/style.css" />
		<link rel="stylesheet" type="text/css" href="/theme/css/pygment.css" />
          <title>Jack Laxson's tech blog - Running CoreDNS for fancy DNS records like SSHFP</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="generator" content="Pelican" />




    <meta name="tags" content="ssh" />
    <meta name="tags" content="incremental security" />

</head>

<body id="index" class="home">
		<main>
		<div id="left-menu">
        <header id="banner" class="body">
                <h1><a href="/">Jack Laxson's tech blog</a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li class="active"><a href="/category/writeup.html">Writeup</a></li>
        </ul></nav><!-- /#menu -->
        </div>
<article>
  <header>
    <h2 class="entry-title">
      <a href="/running-coredns-for-fancy-dns-records-like-sshfp.html" rel="bookmark"
         title="Permalink to Running CoreDNS for fancy DNS records like SSHFP">Running CoreDNS for fancy <span class="caps">DNS</span> records like <span class="caps">SSHFP</span></a></h2>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2020-10-05T00:00:00-04:00">
      Mon 05 October 2020
    </time>
    <address class="vcard author">
      By           <a class="url fn" href="/author/jack-laxson.html">Jack Laxson</a>
    </address>
    <div class="category">
        Category: <a href="/category/writeup.html">Writeup</a>
    </div>
    <div class="tags">
        Tags:
            <a href="/tag/ssh.html">ssh</a>
            <a href="/tag/incremental-security.html">incremental security</a>
    </div>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>This article will not be going into <a href="https://en.wikipedia.org/wiki/SSHFP_record">sshfp records</a> themselves but feature how to use them if your <span class="caps">DNS</span> vendor&#8217;s server doesn&#8217;t support them. I was in this situation with my dns registrar,&nbsp;Namecheap.</p>
<p>I was recommended <a href="https://coredns.io/">CoreDNS</a> as a simple to use, docker-deployment-ready, production <span class="caps">DNS</span> server. Its pretty quick to follow their setup guide and have some domains resolve with <code>dig</code>. <span class="caps">TLDR</span>: <code>docker pull coredns/coredns</code> An important gotcha: openssh requires the records to be signed under <span class="caps">DNSSEC</span>. This is fixed by adding the dnssec plugin into your <code>Corefile</code> and generating the applicable keys. <code>sudo dnssec-keygen -a ECDSAP256SHA256 domain.tld</code> Make sure you mount the public key and private key into the container. with a volume bind. (This could be in a docker-compose.yml file if you were so inclined or had associated&nbsp;services.)</p>
<p>Good CoreDNS&nbsp;plugins:</p>
<ol>
<li><a href="https://coredns.io/plugins/any/">any</a> any prevents creepy scraping&nbsp;requests</li>
<li><a href="https://coredns.io/plugins/metrics/">prometheus</a> (adds support for influxdb scraping) I love <a href="https://www.influxdata.com/products/influxdb-overview/influxdb-2-0/">influxdb2</a> but that&#8217;s for another&nbsp;time.</li>
</ol>
<p>In the end my config looked&nbsp;like:</p>
<p>Corefile:</p>
<div class="highlight"><pre><span></span>jacklaxson.com {
        dnssec {
            key file Kjacklaxson
        }
        file db.jacklaxson.com
        log
        prometheus 0.0.0.0:9153
        any
}
</pre></div>


<p>the important (and not sensitive bits) of my&nbsp;zonefile:</p>
<div class="highlight"><pre><span></span>$ORIGIN jacklaxson.com.
@   3600 IN SOA ns.jacklaxson.com. admin.jacklaxson.com. (
                20200831 ; serial
                7200       ; refresh (2 hours)
                3600       ; retry (1 hour)
                1209600    ; expire (2 weeks)
                3600       ; minimum (1 hour)
                )
server.jacklaxson.com IN SSHFP 4 1 43fda19ed10224240a53193635df39456956fcd370dba277e6b69
server.jacklaxson.com IN SSHFP 4 2 8d798f349510224240a53193635df39456956fcd370dba277e6b69cab5e1628e9
</pre></div>


<p>my docker run&nbsp;command: </p>
<p><code>sudo docker run -it -p 127.0.0.1:9153:9153 -p 53:53/tcp -p 53:53/udp -v 
$PWD/db.jacklaxson.com:/db.jacklaxson.com -v $PWD/Corefile:/Corefile -v $PWD/Kjacklaxson.key:/Kjacklaxson.key -v 
$PWD/Kjacklaxson.private:/Kjacklaxson.private --restart=unless-stopped --name coredns coredns/coredns</code></p>
<p>The stunning result of our&nbsp;labor:</p>
<p><code>ssh -o "VerifyHostKeyDNS ask" -o UserKnownHostsFile=/dev/null server.jacklaxson.com</code> gives&nbsp;you</p>
<div class="highlight"><pre><span></span>The authenticity of host &#39;server.jacklaxson.com (26.....)&#39; can&#39;t be established.
ED25519 key fingerprint is SHA256:j35df39456956fcd370dba..277Ok.
Matching host key fingerprint found in DNS.
Are you sure you want to continue connecting (yes/no/[fingerprint])?
</pre></div>


<p>Tells you about the signature records from <span class="caps">DNSSEC</span>! If you have a recent ssh you&#8217;ll have the fingerprint option so you can paste the fingerprint to&nbsp;accept.</p>
  </div><!-- /.entry-content -->
</article>
        </main>
        <footer><a href="https://github.com/jrabbit/">github</a> - <a href="https://pleroma.debian.social/users/jrabbit">mastodon</a></footer>
</body>
</html>